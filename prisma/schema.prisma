generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id                        String                     @id @default(cuid())
  name                      String
  slug                      String                     @unique
  stripeCustomerId          String?                    @unique
  stripeSubscriptionId      String?                    @unique
  subscriptionStatus        SubscriptionStatus         @default(INACTIVE)
  planInterval              PlanInterval               @default(MONTHLY)
  currentPeriodEnd          DateTime?
  cancelAtPeriodEnd         Boolean                    @default(false)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  dashboardPreferences      DashboardPreference[]
  extraordinaryItemRequests ExtraordinaryItemRequest[]
  fields                    Field[]
  harvestRecords            HarvestRecord[]
  inventoryItems            InventoryItem[]
  inventoryMovements        InventoryMovement[]
  lots                      Lot[]
  tasks                     Task[]
  taskTypes                 TaskType[]
  cropTypes                 CropType[]
  moduleSettings            TenantModuleSetting[]
  invitations               Invitation[]
  memberships               TenantUserMembership[]
  warehouses                Warehouse[]
  workers                   Worker[]
  // Empaque relations
  packingTransports         PackingTransport[]
  packingTruckEntries       PackingTruckEntry[]
  packingBins               PackingBin[]
  preselectionSessions      PreselectionSession[]
  chambers                  Chamber[]
  processSessions           ProcessSession[]
  packingBoxes              PackingBox[]
  pallets                   Pallet[]
  dispatches                Dispatch[]
}

model User {
  id                        String                     @id @default(cuid())
  firstName                 String
  lastName                  String
  email                     String                     @unique
  phone                     String
  passwordHash              String
  role                      UserRole                   @default(SUPERVISOR)
  status                    UserStatus                 @default(INVITED)
  lastAccessAt              DateTime?
  invitedById               String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  dashboardPreferences      DashboardPreference[]
  extraordinaryItemRequests ExtraordinaryItemRequest[] @relation("ExtraordinaryRequestedBy")
  inventoryMovements        InventoryMovement[]        @relation("InventoryMovementCreatedBy")
  createdTasks              Task[]                     @relation("TaskCreatedBy")
  memberships               TenantUserMembership?
  invitedBy                 User?                      @relation("UserInvitations", fields: [invitedById], references: [id])
  invitedUsers              User[]                     @relation("UserInvitations")
  sentInvitations           Invitation[]               @relation("InvitationsSent")
}

model TenantUserMembership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
}

model Invitation {
  id        String           @id @default(cuid())
  tenantId  String
  email     String
  role      UserRole         @default(SUPERVISOR)
  token     String           @unique
  expiresAt DateTime
  status    InvitationStatus @default(PENDING)
  invitedBy String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inviter   User             @relation("InvitationsSent", fields: [invitedBy], references: [id])

  @@index([tenantId])
  @@index([token])
  @@index([email, tenantId])
}

model Field {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  location    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lots        Lot[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Lot {
  id                       String          @id @default(cuid())
  tenantId                 String
  fieldId                  String
  name                     String
  areaHectares             Float
  productionType           String
  plantedFruitsDescription String?
  lastTaskAt               DateTime?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  harvestRecords           HarvestRecord[]
  lotCrops                 LotCrop[]
  field                    Field           @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  tenant                   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  taskLinks                TaskLot[]

  @@unique([fieldId, name])
  @@index([tenantId])
  @@index([fieldId])
}

model Task {
  id                 String               @id @default(cuid())
  tenantId           String
  parentTaskId       String?
  description        String
  taskType           String
  status             TaskStatus           @default(PENDING)
  costValue          Float?
  costUnit           String?
  startDate          DateTime
  dueDate            DateTime
  completedAt        DateTime?
  isComposite        Boolean              @default(false)
  createdById        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  inventoryMovements InventoryMovement[]  @relation("TaskInventoryReference")
  createdBy          User?                @relation("TaskCreatedBy", fields: [createdById], references: [id])
  parentTask         Task?                @relation("TaskHierarchy", fields: [parentTaskId], references: [id])
  subtasks           Task[]               @relation("TaskHierarchy")
  tenant             Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workerAssignments  TaskAssignment[]
  inventoryUsages    TaskInventoryUsage[]
  lotLinks           TaskLot[]
  workLogs           TaskWorkLog[]

  @@index([tenantId, status])
  @@index([dueDate])
}

model TaskLot {
  id        String   @id @default(cuid())
  taskId    String
  lotId     String
  createdAt DateTime @default(now())
  lot       Lot      @relation(fields: [lotId], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, lotId])
  @@index([lotId])
}

model TaskType {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  color     String   @default("#6B7280")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
}

model CropType {
  id        String    @id @default(cuid())
  tenantId  String
  name      String
  color     String    @default("#16a34a")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lotCrops  LotCrop[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model LotCrop {
  id         String   @id @default(cuid())
  lotId      String
  cropTypeId String
  createdAt  DateTime @default(now())
  cropType   CropType @relation(fields: [cropTypeId], references: [id], onDelete: Cascade)
  lot        Lot      @relation(fields: [lotId], references: [id], onDelete: Cascade)

  @@unique([lotId, cropTypeId])
  @@index([lotId])
  @@index([cropTypeId])
}

model Worker {
  id              String              @id @default(cuid())
  tenantId        String
  firstName       String
  lastName        String
  dni             String
  phone           String
  email           String?
  paymentType     WorkerPaymentType
  functionType    String
  hourlyRate      Float?
  taskRate        Float?
  fixedSalary     Float?
  paymentStatus   WorkerPaymentStatus @default(PENDING)
  active          Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  taskAssignments TaskAssignment[]
  workLogs        TaskWorkLog[]
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  preselectionWorkers PreselectionWorker[]

  @@unique([tenantId, dni])
  @@index([tenantId])
}

model TaskAssignment {
  id        String   @id @default(cuid())
  taskId    String
  workerId  String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  worker    Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@unique([taskId, workerId])
  @@index([workerId])
}

model TaskWorkLog {
  id            String              @id @default(cuid())
  taskId        String
  workerId      String
  hoursWorked   Float?
  paymentAmount Float?
  paymentStatus WorkerPaymentStatus @default(PENDING)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  task          Task                @relation(fields: [taskId], references: [id], onDelete: Cascade)
  worker        Worker              @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([workerId])
}

model HarvestRecord {
  id          String   @id @default(cuid())
  tenantId    String
  lotId       String
  cropType    String
  kilos       Float
  harvestDate DateTime @default(now())
  createdAt   DateTime @default(now())
  lot         Lot      @relation(fields: [lotId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, harvestDate])
  @@index([lotId])
}

model Warehouse {
  id                   String               @id @default(cuid())
  tenantId             String
  name                 String
  description          String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  destinationMovements InventoryMovement[]  @relation("DestinationWarehouse")
  sourceMovements      InventoryMovement[]  @relation("SourceWarehouse")
  taskUsages           TaskInventoryUsage[]
  tenant               Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stocks               WarehouseStock[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model InventoryItem {
  id          String               @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String
  unit        String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  movements   InventoryMovement[]
  taskUsages  TaskInventoryUsage[]
  stocks      WarehouseStock[]

  @@unique([tenantId, code])
  @@index([tenantId, name])
}

model WarehouseStock {
  id                String        @id @default(cuid())
  warehouseId       String
  itemId            String
  quantity          Float         @default(0)
  lowThreshold      Float         @default(0)
  criticalThreshold Float         @default(0)
  updatedAt         DateTime      @updatedAt
  item              InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  warehouse         Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, itemId])
  @@index([itemId])
}

model InventoryMovement {
  id                     String                @id @default(cuid())
  tenantId               String
  type                   InventoryMovementType
  itemId                 String
  quantity               Float
  sourceWarehouseId      String?
  destinationWarehouseId String?
  referenceTaskId        String?
  notes                  String?
  createdByUserId        String?
  createdAt              DateTime              @default(now())
  createdByUser          User?                 @relation("InventoryMovementCreatedBy", fields: [createdByUserId], references: [id])
  destinationWarehouse   Warehouse?            @relation("DestinationWarehouse", fields: [destinationWarehouseId], references: [id])
  item                   InventoryItem         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  referenceTask          Task?                 @relation("TaskInventoryReference", fields: [referenceTaskId], references: [id])
  sourceWarehouse        Warehouse?            @relation("SourceWarehouse", fields: [sourceWarehouseId], references: [id])
  tenant                 Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  taskUsage              TaskInventoryUsage?

  @@index([tenantId, createdAt])
  @@index([itemId])
}

model TaskInventoryUsage {
  id              String             @id @default(cuid())
  taskId          String
  inventoryItemId String
  warehouseId     String
  quantity        Float
  unit            String
  movementId      String?            @unique
  createdAt       DateTime           @default(now())
  inventoryItem   InventoryItem      @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  movement        InventoryMovement? @relation(fields: [movementId], references: [id])
  task            Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  warehouse       Warehouse          @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([warehouseId])
}

model ExtraordinaryItemRequest {
  id                String                  @id @default(cuid())
  tenantId          String
  name              String
  description       String
  requestedByUserId String
  requestedAt       DateTime                @default(now())
  status            ExtraordinaryItemStatus @default(PENDING)
  deliveredAt       DateTime?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  requestedByUser   User                    @relation("ExtraordinaryRequestedBy", fields: [requestedByUserId], references: [id])
  tenant            Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
}

model DashboardPreference {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  templateKey String   @default("balanced")
  widgetsJson String   @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
}

model TenantModuleSetting {
  id                      String    @id @default(cuid())
  tenantId                String
  module                  ModuleKey
  enabled                 Boolean   @default(true)
  stripePriceId           String?
  stripeSubscriptionItemId String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  tenant                  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, module])
}

// ═══════════════════════════════════════════════════════
// STRIPE IDEMPOTENCY — prevents duplicate webhook processing
// ═══════════════════════════════════════════════════════

model StripeEvent {
  id            String   @id // Stripe event ID (evt_xxx)
  type          String
  processedAt   DateTime @default(now())

  @@index([type])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum UserRole {
  ADMIN
  SUPERVISOR
}

enum UserStatus {
  INVITED
  ACTIVE
  INACTIVE
}

enum WorkerPaymentType {
  HOURLY
  PER_TASK
  FIXED_SALARY
}

enum WorkerPaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  LATE
}

enum InventoryMovementType {
  INCOME
  TRANSFER
  CONSUMPTION
  ADJUSTMENT
}

enum ExtraordinaryItemStatus {
  PENDING
  DELIVERED
}

enum SubscriptionStatus {
  INACTIVE       // No subscription yet
  TRIALING       // In free trial
  ACTIVE         // Paid and active
  PAST_DUE       // Payment failed, grace period
  CANCELED       // Subscription canceled
  UNPAID         // Multiple payment failures
}

enum PlanInterval {
  MONTHLY
  ANNUAL
}

enum ModuleKey {
  DASHBOARD
  USERS
  WORKERS
  FIELD
  INVENTORY
  MACHINERY
  PACKAGING
  SALES
  SETTINGS
}

// ═══════════════════════════════════════════════════════
// EMPAQUE MODULE MODELS
// ═══════════════════════════════════════════════════════

enum BinStatus {
  IN_YARD
  IN_PRESELECTION
  IN_CHAMBER
  READY_FOR_PROCESS
  IN_PROCESS
  PROCESSED
  DISCARDED
}

enum PreselectionStatus {
  IN_PROGRESS
  PAUSED
  COMPLETED
}

enum ProcessSessionStatus {
  IN_PROGRESS
  PAUSED
  COMPLETED
}



enum BoxDestination {
  MERCADO_INTERNO
  EXPORTACION
}

enum PalletStatus {
  ON_FLOOR
  DISPATCHED
}

enum DispatchStatus {
  PREPARING
  LOADED
  IN_TRANSIT
  DELIVERED
}

model PackingTransport {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
}

model PackingTruckEntry {
  id            String   @id @default(cuid())
  tenantId      String
  remitoNumber  String
  dtv           String
  transport     String
  chassis       String?
  trailer       String?
  driverName    String
  driverDni     String
  operatorId    String?
  producerUnit  String?
  fieldOrigin   String?
  entryDate     DateTime @default(now())
  status        String   @default("PENDING")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bins          PackingBin[]

  @@index([tenantId, entryDate])
}

model PackingBin {
  id               String    @id @default(cuid())
  tenantId         String
  code             String
  binIdentifier    String?
  fieldName        String
  fruitType        String
  lotName          String
  contractor       String?
  harvestType      String?
  binType          String?
  emptyWeight      Float?
  netWeight        Float
  isTrazable       Boolean   @default(true)
  status           BinStatus @default(IN_YARD)
  truckEntryId     String?
  preselectionId   String?
  internalLot      String?
  fruitColor       String?
  fruitQuality     String?
  caliber          String?
  chamberId        String?
  chamberEntryDate DateTime?
  chamberExitDate  DateTime?
  parentBinId      String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  truckEntry       PackingTruckEntry? @relation(fields: [truckEntryId], references: [id])
  preselection     PreselectionSession? @relation("PreselectionOutputBins", fields: [preselectionId], references: [id])
  chamber          Chamber?  @relation(fields: [chamberId], references: [id])
  parentBin        PackingBin? @relation("BinHierarchy", fields: [parentBinId], references: [id])
  childBins        PackingBin[] @relation("BinHierarchy")
  preselectionInputBins PreselectionBin[]
  processInputBins      ProcessBin[]

  @@unique([tenantId, code])
  @@index([tenantId, status])
}

model PreselectionSession {
  id                 String              @id @default(cuid())
  tenantId           String
  code               String
  status             PreselectionStatus  @default(IN_PROGRESS)
  startTime          DateTime            @default(now())
  endTime            DateTime?
  pausedAt           DateTime?
  totalDurationHours Float?
  pauseCount         Int                 @default(0)
  totalPauseHours    Float?              @default(0)
  discardKg          Float               @default(0)
  notes              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inputBins          PreselectionBin[]
  outputBins         PackingBin[]        @relation("PreselectionOutputBins")
  workers            PreselectionWorker[]
  inputs             PreselectionInput[]
  outputConfig       PreselectionOutputConfig[]

  @@unique([tenantId, code])
  @@index([tenantId, startTime])
}

model PreselectionBin {
  id             String              @id @default(cuid())
  preselectionId String
  binId          String
  addedAt        DateTime            @default(now())
  preselection   PreselectionSession @relation(fields: [preselectionId], references: [id], onDelete: Cascade)
  bin            PackingBin          @relation(fields: [binId], references: [id])

  @@unique([preselectionId, binId])
}

model PreselectionOutputConfig {
  id             String              @id @default(cuid())
  preselectionId String
  outputNumber   Int
  color          String?
  caliber        String?
  isDiscard      Boolean             @default(false)
  label          String?
  preselection   PreselectionSession @relation(fields: [preselectionId], references: [id], onDelete: Cascade)

  @@unique([preselectionId, outputNumber])
}

model PreselectionWorker {
  id             String              @id @default(cuid())
  preselectionId String
  workerId       String
  role           String?
  hoursWorked    Float?
  preselection   PreselectionSession @relation(fields: [preselectionId], references: [id], onDelete: Cascade)
  worker         Worker              @relation(fields: [workerId], references: [id])

  @@index([preselectionId])
}

model PreselectionInput {
  id             String              @id @default(cuid())
  preselectionId String
  itemName       String
  quantity       Float
  unit           String
  cost           Float?
  preselection   PreselectionSession @relation(fields: [preselectionId], references: [id], onDelete: Cascade)

  @@index([preselectionId])
}

model Chamber {
  id        String       @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bins      PackingBin[]
  tasks     ChamberTask[]

  @@unique([tenantId, name])
}

model ChamberTask {
  id          String   @id @default(cuid())
  chamberId   String
  type        String
  description String
  cost        Float?
  date        DateTime @default(now())
  chamber     Chamber  @relation(fields: [chamberId], references: [id], onDelete: Cascade)

  @@index([chamberId, date])
}

model ProcessSession {
  id                    String               @id @default(cuid())
  tenantId              String
  code                  String
  status                ProcessSessionStatus @default(IN_PROGRESS)
  startTime             DateTime             @default(now())
  endTime               DateTime?
  totalDurationHours    Float?
  pauseCount            Int                  @default(0)
  totalPauseHours       Float?               @default(0)
  cleanDiscardKg        Float                @default(0)
  contaminatedDiscardKg Float                @default(0)
  notes                 String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  tenant                Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inputBins             ProcessBin[]
  boxes                 PackingBox[]
  products              ProcessProduct[]

  @@unique([tenantId, code])
  @@index([tenantId, startTime])
}

model ProcessBin {
  id               String         @id @default(cuid())
  processSessionId String
  binId            String
  addedAt          DateTime       @default(now())
  processSession   ProcessSession @relation(fields: [processSessionId], references: [id], onDelete: Cascade)
  bin              PackingBin     @relation(fields: [binId], references: [id])

  @@unique([processSessionId, binId])
}

model ProcessProduct {
  id               String         @id @default(cuid())
  processSessionId String
  productName      String
  quantity         Float
  unit             String
  cost             Float?
  processSession   ProcessSession @relation(fields: [processSessionId], references: [id], onDelete: Cascade)

  @@index([processSessionId])
}

model PackingBox {
  id               String        @id @default(cuid())
  tenantId         String
  code             String
  product          String
  producer         String?
  caliber          String
  category         String
  packagingCode    String?
  destination      BoxDestination
  weightKg         Float
  processSessionId String?
  palletId         String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  processSession   ProcessSession? @relation(fields: [processSessionId], references: [id])
  pallet           Pallet?       @relation(fields: [palletId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId, palletId])
}

model Pallet {
  id              String           @id @default(cuid())
  tenantId        String
  number          Int
  code            String
  status          PalletStatus     @default(ON_FLOOR)
  operatorName    String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  boxes           PackingBox[]
  dispatchPallets DispatchPallet[]

  @@unique([tenantId, code])
  @@index([tenantId, status])
}

model Dispatch {
  id              String         @id @default(cuid())
  tenantId        String
  code            String
  clientName      String
  clientType      String?
  saleType        String?
  deliveryAddress String?
  remitoNumber    String?
  dtv             String?
  dtc             String?
  closingCode     String?
  destination     String?
  discharge       String?
  transport       String?
  driverName      String?
  licensePlate    String?
  departureDate   DateTime?
  departureTime   String?
  status          DispatchStatus @default(PREPARING)
  observations    String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  tenant          Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pallets         DispatchPallet[]

  @@unique([tenantId, code])
  @@index([tenantId, status])
}

model DispatchPallet {
  id         String   @id @default(cuid())
  dispatchId String
  palletId   String
  dispatch   Dispatch @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  pallet     Pallet   @relation(fields: [palletId], references: [id])

  @@unique([dispatchId, palletId])
}
