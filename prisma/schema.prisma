generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("SEEDOR_DATABASE_URL")
}

enum UserRole {
  ADMIN
  SUPERVISOR
}

enum UserStatus {
  INVITED
  ACTIVE
  INACTIVE
}

enum WorkerPaymentType {
  HOURLY
  PER_TASK
  FIXED_SALARY
}

enum WorkerPaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  LATE
}

enum InventoryMovementType {
  INCOME
  TRANSFER
  CONSUMPTION
  ADJUSTMENT
}

enum ExtraordinaryItemStatus {
  PENDING
  DELIVERED
}

enum ModuleKey {
  DASHBOARD
  USERS
  WORKERS
  FIELD
  INVENTORY
  MACHINERY
  PACKAGING
  SALES
  SETTINGS
}

model Tenant {
  id                        String                     @id @default(cuid())
  name                      String
  slug                      String                     @unique
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  memberships               TenantUserMembership[]
  fields                    Field[]
  lots                      Lot[]
  tasks                     Task[]
  workers                   Worker[]
  warehouses                Warehouse[]
  inventoryItems            InventoryItem[]
  inventoryMovements        InventoryMovement[]
  harvestRecords            HarvestRecord[]
  extraordinaryItemRequests ExtraordinaryItemRequest[]
  dashboardPreferences      DashboardPreference[]
  moduleSettings            TenantModuleSetting[]
}

model User {
  id                        String                     @id @default(cuid())
  firstName                 String
  lastName                  String
  email                     String                     @unique
  phone                     String
  passwordHash              String
  role                      UserRole                   @default(SUPERVISOR)
  status                    UserStatus                 @default(INVITED)
  lastAccessAt              DateTime?
  invitedById               String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  invitedBy                 User?                      @relation("UserInvitations", fields: [invitedById], references: [id], onDelete: SetNull)
  invitedUsers              User[]                     @relation("UserInvitations")
  memberships               TenantUserMembership[]
  createdTasks              Task[]                     @relation("TaskCreatedBy")
  inventoryMovements        InventoryMovement[]        @relation("InventoryMovementCreatedBy")
  dashboardPreferences      DashboardPreference[]
  extraordinaryItemRequests ExtraordinaryItemRequest[] @relation("ExtraordinaryRequestedBy")
}

model TenantUserMembership {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@unique([userId])
  @@index([tenantId])
}

model Field {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  location    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lots        Lot[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Lot {
  id                       String          @id @default(cuid())
  tenantId                 String
  fieldId                  String
  name                     String
  areaHectares             Float
  productionType           String
  plantedFruitsDescription String?
  lastTaskAt               DateTime?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  tenant                   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  field                    Field           @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  taskLinks                TaskLot[]
  harvestRecords           HarvestRecord[]

  @@unique([fieldId, name])
  @@index([tenantId])
  @@index([fieldId])
}

model Task {
  id                 String               @id @default(cuid())
  tenantId           String
  parentTaskId       String?
  description        String
  taskType           String
  status             TaskStatus           @default(PENDING)
  costValue          Float?
  costUnit           String?
  startDate          DateTime
  dueDate            DateTime
  completedAt        DateTime?
  isComposite        Boolean              @default(false)
  createdById        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  tenant             Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentTask         Task?                @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: SetNull)
  subtasks           Task[]               @relation("TaskHierarchy")
  createdBy          User?                @relation("TaskCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  lotLinks           TaskLot[]
  workerAssignments  TaskAssignment[]
  workLogs           TaskWorkLog[]
  inventoryUsages    TaskInventoryUsage[]
  inventoryMovements InventoryMovement[]  @relation("TaskInventoryReference")

  @@index([tenantId, status])
  @@index([dueDate])
}

model TaskLot {
  id        String   @id @default(cuid())
  taskId    String
  lotId     String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  lot       Lot      @relation(fields: [lotId], references: [id], onDelete: Cascade)

  @@unique([taskId, lotId])
  @@index([lotId])
}

model Worker {
  id              String              @id @default(cuid())
  tenantId        String
  firstName       String
  lastName        String
  dni             String
  phone           String
  email           String?
  paymentType     WorkerPaymentType
  functionType    String
  hourlyRate      Float?
  taskRate        Float?
  fixedSalary     Float?
  paymentStatus   WorkerPaymentStatus @default(PENDING)
  active          Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  taskAssignments TaskAssignment[]
  workLogs        TaskWorkLog[]

  @@unique([tenantId, dni])
  @@index([tenantId])
}

model TaskAssignment {
  id        String   @id @default(cuid())
  taskId    String
  workerId  String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  worker    Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@unique([taskId, workerId])
  @@index([workerId])
}

model TaskWorkLog {
  id            String              @id @default(cuid())
  taskId        String
  workerId      String
  hoursWorked   Float?
  paymentAmount Float?
  paymentStatus WorkerPaymentStatus @default(PENDING)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  task          Task                @relation(fields: [taskId], references: [id], onDelete: Cascade)
  worker        Worker              @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([workerId])
}

model HarvestRecord {
  id          String   @id @default(cuid())
  tenantId    String
  lotId       String
  cropType    String
  kilos       Float
  harvestDate DateTime @default(now())
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lot         Lot      @relation(fields: [lotId], references: [id], onDelete: Cascade)

  @@index([tenantId, harvestDate])
  @@index([lotId])
}

model Warehouse {
  id                   String               @id @default(cuid())
  tenantId             String
  name                 String
  description          String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  tenant               Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stocks               WarehouseStock[]
  taskUsages           TaskInventoryUsage[]
  sourceMovements      InventoryMovement[]  @relation("SourceWarehouse")
  destinationMovements InventoryMovement[]  @relation("DestinationWarehouse")

  @@unique([tenantId, name])
  @@index([tenantId])
}

model InventoryItem {
  id          String               @id @default(cuid())
  tenantId    String
  code        String
  name        String
  description String
  unit        String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stocks      WarehouseStock[]
  movements   InventoryMovement[]
  taskUsages  TaskInventoryUsage[]

  @@unique([tenantId, code])
  @@index([tenantId, name])
}

model WarehouseStock {
  id                String        @id @default(cuid())
  warehouseId       String
  itemId            String
  quantity          Float         @default(0)
  lowThreshold      Float         @default(0)
  criticalThreshold Float         @default(0)
  updatedAt         DateTime      @updatedAt
  warehouse         Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  item              InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, itemId])
  @@index([itemId])
}

model InventoryMovement {
  id                     String                @id @default(cuid())
  tenantId               String
  type                   InventoryMovementType
  itemId                 String
  quantity               Float
  sourceWarehouseId      String?
  destinationWarehouseId String?
  referenceTaskId        String?
  notes                  String?
  createdByUserId        String?
  createdAt              DateTime              @default(now())
  tenant                 Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item                   InventoryItem         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  sourceWarehouse        Warehouse?            @relation("SourceWarehouse", fields: [sourceWarehouseId], references: [id], onDelete: SetNull)
  destinationWarehouse   Warehouse?            @relation("DestinationWarehouse", fields: [destinationWarehouseId], references: [id], onDelete: SetNull)
  referenceTask          Task?                 @relation("TaskInventoryReference", fields: [referenceTaskId], references: [id], onDelete: SetNull)
  createdByUser          User?                 @relation("InventoryMovementCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  taskUsage              TaskInventoryUsage?

  @@index([tenantId, createdAt])
  @@index([itemId])
}

model TaskInventoryUsage {
  id              String             @id @default(cuid())
  taskId          String
  inventoryItemId String
  warehouseId     String
  quantity        Float
  unit            String
  movementId      String?            @unique
  createdAt       DateTime           @default(now())
  task            Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem      @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)
  warehouse       Warehouse          @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  movement        InventoryMovement? @relation(fields: [movementId], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([warehouseId])
}

model ExtraordinaryItemRequest {
  id                String                  @id @default(cuid())
  tenantId          String
  name              String
  description       String
  requestedByUserId String
  requestedAt       DateTime                @default(now())
  status            ExtraordinaryItemStatus @default(PENDING)
  deliveredAt       DateTime?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  tenant            Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  requestedByUser   User                    @relation("ExtraordinaryRequestedBy", fields: [requestedByUserId], references: [id], onDelete: Restrict)

  @@index([tenantId, status])
}

model DashboardPreference {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String
  templateKey String   @default("balanced")
  widgetsJson String   @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
}

model TenantModuleSetting {
  id        String    @id @default(cuid())
  tenantId  String
  module    ModuleKey
  enabled   Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, module])
}
